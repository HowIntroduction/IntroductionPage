<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>검색 결과</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.js"></script>

    <style>
      .slider {
        width: 100vw;
        margin: 0 auto;
      }

      .slider img {
        width: 100%;
        height: 100%;
        max-height: 400px; /* 슬라이더 이미지의 최대 높이 설정 */
        object-fit: cover; /* 이미지가 슬라이더를 꽉 채우도록 설정 */
        border-radius: 10px;
      }

      .slick-dots {
        position: relative;
        margin-top: -8% !important;
        z-index: 9999;
      }
      .cards-container {
        margin-top: 120px;
        max-width: 1072px;
        width: 100%;
        padding: 0 24px;
      }
      .card-section {
        margin-bottom: 40px;
      }
      /* 카드 스타일링 */
      .card {
        border: 1px solid rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        overflow: hidden;
        transition: transform 0.2s ease;
      }

      .card:hover {
        transform: translateY(-4px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      }

      .card-img-top {
        width: 100%;
        height: 200px;
        object-fit: cover;
      }

      .card-body {
        padding: 16px;
      }

      .card-footer {
        padding: 12px 16px;
        background-color: rgba(0, 0, 0, 0.02);
      }

      /* 반응형 디자인 */
      @media (max-width: 992px) {
        .cards-grid {
          grid-template-columns: repeat(2, 1fr);
        }
      }

      @media (max-width: 576px) {
        .cards-grid {
          grid-template-columns: 1fr;
        }
      }
      /* 필요 없을 시 삭제할 것 */
      .main,
      #add_detail {
        background-color: gray;
        background-size: cover;
        background-position: center;
        display: flex;
        flex-direction: row;
        height: 600px;
        margin: 30px 30px 30px 30px;
      }
    </style>

    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        getDocs,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

      const CARDS_FOR_SECTION = 3;

      const initFirebase = () => {
        const firebaseConfig = {
          apiKey: "AIzaSyClPXmUFKKAr6m1lFyn-v1W65Dl-X4foWE",
          authDomain: "sparta-dafac.firebaseapp.com",
          projectId: "sparta-dafac",
          storageBucket: "sparta-dafac.firebasestorage.app",
          messagingSenderId: "466405941138",
          appId: "1:466405941138:web:9ff4fb0ae5f6f861622b4b",
          measurementId: "G-FWYNHPBX6W",
        };
        const app = initializeApp(firebaseConfig);

        return getFirestore(app);
      };

      const getMemberList = async () => {
        const db = initFirebase();
        console.log(db, "introduce");
        const rawMembers = await getDocs(collection(db, "introduce"));
        console.log(rawMembers, "rawMembers");

        /*
        const members = rawMembers.docs.map((doc) => ({
          id: doc.data().id,
          user_name: doc.data().user_name,
          user_card: doc.data().user_card,
          text1: doc.data().text1,
          text2: doc.data().text2,
          image1: doc.data().image1,
          mbti_image: doc.data().mbti_image,
          mbti_text: doc.data().mbti_text,
        }));
        */
        const members = rawMembers.docs.map((doc) => ({
          id: doc.data().id,
          main_image: doc.data().main_image,
          main_text: doc.data().main_text,
          sub_image1: doc.data().sub_image1,
          sub_image2: doc.data().sub_image2,
          sub_text1: doc.data().sub_text1,
          sub_text2: doc.data().sub_text2,
        }));

        return searchMemberList(members);
      };

      const searchMemberList = (memberList) => {
        // 검색 값을 받아와 memberList에 대해 검색
        const search = new URLSearchParams(window.location.search);
        const search_id = search.get("id");

        const searchList = memberList.filter(
          (member) => member.id.indexOf(search_id) != -1
        );

        return searchList;
      };

      const setCurrentMember = (member) => {
        localStorage.setItem("currentMember", member);
        presentCurrentMember(member);
      };

      const presentCurrentMember = (member) => {
        $(".mainbox").attr("src", member.main_image);
        $(".text").text(member.main_text);
      };

      // 페이지 최초 로딩 시 실행
      $(document).ready(async () => {
        const searchList = await getMemberList();

        const root = $("#container");
        console.log(searchList, "searchList");

        // Create main container
        root.append('<div class="cards-container"></div>');
        const container = $(".cards-container");

        // Calculate number of sections needed
        const numSections = Math.ceil(searchList.length / CARDS_FOR_SECTION);

        for (let i = 0; i < numSections; i++) {
          const sectionHTML = `
                  <div class="card-section" id="section${i}">
                      <div class="row row-cols-1 row-cols-md-3 g-4">
                      </div>
                  </div>
              `;
          container.append(sectionHTML);

          // Add cards for this section
          const startIdx = i * CARDS_FOR_SECTION;
          const endIdx = Math.min(
            startIdx + CARDS_FOR_SECTION,
            searchList.length
          );

          for (let j = startIdx; j < endIdx; j++) {
            const member = searchList[j];
            const cardHTML = `
                      <div class="col">
                          <div class="card h-100">
                              <img src="${
                                member.main_image
                              }" class="card-img-top" alt="Member ${j + 1}" />
                              <div class="card-body">
                                  <h5 class="card-title">멤버 ${j + 1}</h5>
                                  <p class="card-text">${member.main_text}</p>
                              </div>
                              <div class="card-footer">
                                  <small class="text-body-secondary">앨범 날짜</small>
                              </div>
                          </div>
                      </div>
                  `;
            $(`#section${i} .row`).append(cardHTML);
          }
        }

        // 2. 카드 클릭 이벤트 수정
        searchList.forEach((member, index) => {
          $(`.col:eq(${index}) .card`).click(() => {
            setCurrentMember(member);
            // 상세 페이지로 이동
            window.location.href = `./subpage1.html?id=${member.id}`;
          });
        });

        // Page redirection on click
        $("#add_detail").click(() => {
          window.location.href = "./adddetail.html";
        });
      });
      $(document).ready(async () => {
        const searchList = await getMemberList();

        // 최신 5개의 이미지를 슬라이더에 추가
        const latestMembers = searchList.slice(-5).reverse(); // 최신 5개만 추출하여 최신순으로 정렬

        const slider = $("#slider");
        latestMembers.forEach((member) => {
          slider.append(`
            <div>
              <img src="${member.main_image}" alt="Latest Image" />
            </div>
          `);
        });

        // Slick Slider 초기화
        slider.slick({
          dots: true,
          infinite: true,
          speed: 300,
          slidesToShow: 1,
          adaptiveHeight: false,
          fade: false,
        });
      });
    </script>
  </head>

  <body>
    <div id="header" class="header"></div>
    <div class="section1" id="section1">
      <div class="slider" id="slider"></div>
    </div>
    <div class="cards-container"></div>
    <div id="footer" class="footer"></div>
  </body>
  <script>
    $(window).on("load", function () {
      // 헤더 및 푸터 로드
      $("#header").load("header.html");
      $("#footer").load("footer.html");
    });
  </script>
</html>
