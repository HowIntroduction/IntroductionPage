<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>방명록</title>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.5.1/jquery.min.js"></script>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC"
      crossorigin="anonymous"
    />
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <link rel="stylesheet" href="styles.css" />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick.min.css"
    />
    <link
      rel="stylesheet"
      type="text/css"
      href="https://cdnjs.cloudflare.com/ajax/libs/slick-carousel/1.8.1/slick-theme.min.css"
    />
    <style>
      @import url("https://fonts.googleapis.com/css2?family=Dongle&display=swap");
      * {
        font-family: "Dongle", sans-serif;
        font-weight: 400;
        font-style: normal;
      }
      .note-area {
        background-color: aqua;
        height: 100%;
        width: 50%;
      }
    </style>
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
      import {
        getFirestore,
        collection,
        addDoc,
        getDocs,
        deleteDoc,
        doc,
      } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
      // Firebase 구성 정보 설정
      const firebaseConfig = {
        apiKey: "AIzaSyClPXmUFKKAr6m1lFyn-v1W65Dl-X4foWE",
        authDomain: "sparta-dafac.firebaseapp.com",
        projectId: "sparta-dafac",
        storageBucket: "sparta-dafac.firebasestorage.app",
        messagingSenderId: "466405941138",
        appId: "1:466405941138:web:9ff4fb0ae5f6f861622b4b",
        measurementId: "G-FWYNHPBX6W",
      };
      // Firebase 인스턴스 초기화
      const app = initializeApp(firebaseConfig);
      const db = getFirestore(app);
      // Firestore에서 방명록 기록을 가져와 화면에 표시하는 함수
      async function getNotes() {
        const note_history = document.getElementById("note");
        note_history.innerHTML = ""; // 기존 내용 초기화
        try {
          const note_data = await getDocs(collection(db, "note"));
          note_data.forEach((target) => {
            const data = target.data();
            const noteElement = document.createElement("p");
            // 방명록 항목 내용
            noteElement.textContent = `${data.name}님의 메시지 : ${data.content} `;
            // 삭제 버튼 생성
            const deleteButton = document.createElement("button");
            deleteButton.textContent = "삭제";
            deleteButton.classList.add("btn", "btn-danger", "btn-sm", "ms-2");
            // 삭제 버튼 클릭 이벤트 추가
            deleteButton.addEventListener("click", async () => {
              try {
                await deleteDoc(doc(db, "note", target.id));
                alert("방명록 항목이 삭제완료");
                getNotes(); // 화면 갱신
              } catch (error) {
                console.error("방명록 삭제 오류:", error);
              }
            });
            // noteElement에 삭제 버튼 추가
            noteElement.appendChild(deleteButton);
            note_history.appendChild(noteElement);
          });
        } catch (error) {
          console.error("방명록 데이터를 불러오는 중 오류 발생:", error);
        }
      }

      $("#submitbtn").click(async function () {
        const name = $("#noteName").val();
        const content = $("#noteContent").val();
        if (!name || !content) {
          alert("모든 필드를 채워주세요!");
        } else {
          const doc = {
            name: name,
            content: content,
          };
          try {
            await addDoc(collection(db, "note"), doc);
            alert("방명록 작성 완료!");
            getNotes();
            // 입력 필드 초기화
            $("#noteName").val("");
            $("#noteContent").val("");
          } catch (e) {
            console.error("방명록 작성 중 오류:", e);
          }
        }
      });
      document.addEventListener("DOMContentLoaded", getNotes);
    </script>
  </head>
  <body>
    <div class="header" id="header"></div>
    <!-- 방명록 영역 -->
    <div class="note-area">
      <div class="note" id="note"></div>

      <!-- 이름과 댓글을 입력받는 영역 -->
      <div class="input-group input-group-sm mb-3">
        <span class="input-group-text">이름</span>
        <input
          type="text"
          class="form-control"
          id="noteName"
          placeholder="이름을 입력하세요"
        />

        <span class="input-group-text">댓글</span>
        <input
          type="text"
          class="form-control"
          id="noteContent"
          placeholder="댓글을 입력하세요"
        />

        <button class="btn btn-primary" id="submitbtn">등록</button>
      </div>
    </div>

    <div class="footer" id="footer"></div>
  </body>
  <script>
    $(window).on("load", function () {
      $("#header").load("header.html");
      $("#footer").load("footer.html");
    });
  </script>
</html>
